<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>概述 | 鸭库scheme-lib</title>
    <meta name="generator" content="VuePress 1.7.1">
    <script>
      (function() {
      var hm1 = document.createElement("script");
      hm1.src = "https://www.googletagmanager.com/gtag/js?id=G-XM4XMJ9T7L";
      var s1 = document.getElementsByTagName("script")[0]; 
      s1.parentNode.insertBefore(hm1, s1);
      })();

      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-XM4XMJ9T7L');
        </script>
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/scheme-lib/assets/css/0.styles.be889c48.css" as="style"><link rel="preload" href="/scheme-lib/assets/js/app.7d3796fb.js" as="script"><link rel="preload" href="/scheme-lib/assets/js/2.717986cd.js" as="script"><link rel="preload" href="/scheme-lib/assets/js/3.3680f9a6.js" as="script"><link rel="preload" href="/scheme-lib/assets/js/16.d05c1140.js" as="script"><link rel="prefetch" href="/scheme-lib/assets/js/10.9f689f80.js"><link rel="prefetch" href="/scheme-lib/assets/js/11.e96ec370.js"><link rel="prefetch" href="/scheme-lib/assets/js/12.0c97394b.js"><link rel="prefetch" href="/scheme-lib/assets/js/13.c0c38b07.js"><link rel="prefetch" href="/scheme-lib/assets/js/14.49061573.js"><link rel="prefetch" href="/scheme-lib/assets/js/15.a196a7d1.js"><link rel="prefetch" href="/scheme-lib/assets/js/17.20acbcd8.js"><link rel="prefetch" href="/scheme-lib/assets/js/18.225fd011.js"><link rel="prefetch" href="/scheme-lib/assets/js/19.7156d96c.js"><link rel="prefetch" href="/scheme-lib/assets/js/20.ddb59844.js"><link rel="prefetch" href="/scheme-lib/assets/js/21.76b988dc.js"><link rel="prefetch" href="/scheme-lib/assets/js/22.b490eaf0.js"><link rel="prefetch" href="/scheme-lib/assets/js/23.756a7dd8.js"><link rel="prefetch" href="/scheme-lib/assets/js/24.bcac95eb.js"><link rel="prefetch" href="/scheme-lib/assets/js/25.2e524cd3.js"><link rel="prefetch" href="/scheme-lib/assets/js/26.39967ac9.js"><link rel="prefetch" href="/scheme-lib/assets/js/27.f8e4c083.js"><link rel="prefetch" href="/scheme-lib/assets/js/28.88482de7.js"><link rel="prefetch" href="/scheme-lib/assets/js/29.5fa2fe9a.js"><link rel="prefetch" href="/scheme-lib/assets/js/30.dd0552c7.js"><link rel="prefetch" href="/scheme-lib/assets/js/31.cf140346.js"><link rel="prefetch" href="/scheme-lib/assets/js/32.ba3c6be0.js"><link rel="prefetch" href="/scheme-lib/assets/js/33.c0ca864c.js"><link rel="prefetch" href="/scheme-lib/assets/js/34.306a5faf.js"><link rel="prefetch" href="/scheme-lib/assets/js/35.2238a00d.js"><link rel="prefetch" href="/scheme-lib/assets/js/36.a8ac7a0b.js"><link rel="prefetch" href="/scheme-lib/assets/js/4.a7d87990.js"><link rel="prefetch" href="/scheme-lib/assets/js/5.918194ec.js"><link rel="prefetch" href="/scheme-lib/assets/js/6.c251f99b.js"><link rel="prefetch" href="/scheme-lib/assets/js/7.3d818c5a.js"><link rel="prefetch" href="/scheme-lib/assets/js/8.2d51dbde.js"><link rel="prefetch" href="/scheme-lib/assets/js/9.c7da5c3d.js">
    <link rel="stylesheet" href="/scheme-lib/assets/css/0.styles.be889c48.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/scheme-lib/" class="home-link router-link-active"><!----> <span class="site-name">鸭库scheme-lib</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links menu can-hide"><div class="nav-item"><a href="/scheme-lib/guide/" class="nav-link">
  新手指南
</a></div><div class="nav-item"><a href="/scheme-lib/docs/" class="nav-link router-link-active">
  文档
</a></div><div class="nav-item"><a href="/scheme-lib/about/" class="nav-link">
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/scheme-lib/guide/" class="nav-link">
  新手指南
</a></div><div class="nav-item"><a href="/scheme-lib/docs/" class="nav-link router-link-active">
  文档
</a></div><div class="nav-item"><a href="/scheme-lib/about/" class="nav-link">
  关于
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>第一章 介绍</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/scheme-lib/docs/第一章 介绍/1.0 概述.html" class="sidebar-link">1 关于scheme</a></li><li><a href="/scheme-lib/docs/第一章 介绍/1.1 scheme-lib库.html" class="sidebar-link">1 基本概念</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第二章 入门</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/scheme-lib/docs/第二章 入门/2.1 scheme-lib安装.html" class="sidebar-link">1 linux、mac下安装</a></li><li><a href="/scheme-lib/docs/第二章 入门/2.2 win下编译安装.html" class="sidebar-link">0 警告⚠️</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第三章 输入输出</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/scheme-lib/docs/第三章 输入输出/3.1 输入输出.html" class="sidebar-link">1 输入</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第四章 GUI库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/scheme-lib/docs/第四章 GUI库/4.2 gui库使用.html" class="sidebar-link">1 gui库使用</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第五章 FFI库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/scheme-lib/docs/第五章 FFI库/5.0 ffi库的概述.html" class="sidebar-link">什么是 ffi ？</a></li><li><a href="/scheme-lib/docs/第五章 FFI库/5.1 cffi库使用.html" class="sidebar-link">1 cffi库使用</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>附录 例子</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/scheme-lib/docs/附录 例子/2D物理引擎.html" class="sidebar-link">/docs/附录 例子/2D物理引擎.html</a></li><li><a href="/scheme-lib/docs/附录 例子/打飞机游戏.html" class="sidebar-link">/docs/附录 例子/打飞机游戏.html</a></li><li><a href="/scheme-lib/docs/附录 例子/计算器.html" class="sidebar-link">/docs/附录 例子/计算器.html</a></li><li><a href="/scheme-lib/docs/附录 例子/远程解释器.html" class="sidebar-link">/docs/附录 例子/远程解释器.html</a></li><li><a href="/scheme-lib/docs/附录 例子/GUI图形库.html" class="sidebar-link">/docs/附录 例子/GUI图形库.html</a></li><li><a href="/scheme-lib/docs/附录 例子/Http下载.html" class="sidebar-link">/docs/附录 例子/Http下载.html</a></li><li><a href="/scheme-lib/docs/附录 例子/mysql数据库连接例子.html" class="sidebar-link">/docs/附录 例子/mysql数据库连接例子.html</a></li><li><a href="/scheme-lib/docs/附录 例子/OpenGL开发.html" class="sidebar-link">/docs/附录 例子/OpenGL开发.html</a></li><li><a href="/scheme-lib/docs/附录 例子/web服务器.html" class="sidebar-link">/docs/附录 例子/web服务器.html</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>鸭子实验室</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/scheme-lib/docs/%E9%B8%AD%E5%AD%90%E5%AE%9E%E9%AA%8C%E5%AE%A4/" class="sidebar-link">/docs/%E9%B8%AD%E5%AD%90%E5%AE%9E%E9%AA%8C%E5%AE%A4/</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <p>宏的使用是scheme的最大的精华和难度，这里只是一个简单的概括，阅读者还需要寻找更多的资料，在实践中自行体会scheme宏的应用。
鸭库中最易找到的用宏编写的程序位于 packages/utils/macro.ss中
这个库文件中的导出的接口都是由scheme的宏（marco.ss）编写生成的，下面是一个例子</p> <div class="language-scheme extra-class"><pre class="language-scheme"><code><span class="token punctuation">(</span><span class="token keyword">define-syntax</span> while
  <span class="token punctuation">(</span><span class="token keyword">syntax-rules</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    [<span class="token punctuation">(</span><span class="token function">_</span> test body ...<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">when</span> test body ... <span class="token punctuation">(</span><span class="token function">loop</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>]<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="过程宏与安全宏"><a href="#过程宏与安全宏" class="header-anchor">#</a> 过程宏与安全宏</h2> <p>这个例子的开头是这样子的：</p> <div class="language-scheme extra-class"><pre class="language-scheme"><code><span class="token punctuation">(</span><span class="token keyword">define-syntax</span> while
  <span class="token punctuation">(</span><span class="token keyword">syntax-rules</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>为何要用两个嵌套的过程定义一个宏，是因为它们不是相同类型的宏语句。
要搞明白这个概念，首先必须先看文档 7.1 什么是宏。
scheme是一种Lisp方言，1963年Timothy Hart提议在Lisp 1.5中加入宏，从此Lisp就有了宏，由于Lisp的宏功能强大，因此宏成为了Lisp的重要标签。但是当时的宏从表达能力上说与今天的宏还相距甚远。
后来Scheme和Lisp方言就有了照应宏，照应宏特别强大，几乎达到理论所允许的极致，因而广泛流行。
到了R5RS，引入了安全宏（直译是卫生宏的意思）的概念。但是卫生宏是一个有争议性的概念，诞生了许多实践，也招致了许多批评。卫生宏的诞生并没有提升宏的表达能力，这与照应宏大大提升了早期的宏的表达能力不同。而且卫生宏隐含着照应宏是“不卫生的”，但是实际上这是错的，用照应宏完全可以写出卫生宏过程本身，相反用卫生宏也是照应宏过程的（不保证写出的与语言自身实现的运行速度一样）。
这引发了思想的混乱，因为从安全的角度说，卫生宏的反义词是过程宏。但是从版本的角度说卫生宏又是照应宏的升级。这是一个建立在同时发展两个概念基础之上的概念。</p> <p>说回一开始的问题，define-syntax和syntax-rules到底有什么区别？
define-syntax 原本是一个照应宏，可以写的比较脏（软件工程习语，指代码不合规范难读，与清洁宏的干净相对）也可以写出清洁的宏。
syntax-rules 是一种具备几乎所有照应功能的全清洁宏，在它作用代码块内不能出现脏代码。用syntax-rules写出来的宏肯定可以写的非常优雅。但是不具有宏的所有表现能力
将define-syntax 中嵌套syntax-rules 是在一个可能被写成过程宏的宏定义内嵌套一个完全清洁的宏，既努力实现宏的完全清洁又为其中可能出现一些过程宏留下了空间。</p> <p>前面说到卫生宏“诞生了许多实践”，其中就包括宏的写法，syntax-rules是一种比较流行的实践，但是也还有另一种实践是syntax-case，chez scheme 两种都支持。syntax-case的用法在此不作详细说明，只指出它和syntax-rules存在的不同。
syntax-case 是一种具备完全具备所有照应功能的清洁宏，但是用它也可以写出过程宏。chez 的 syntax-case 可以写出任意的照应宏。但是与传统的照应宏过程相比，syntax-case 提供了更多的辅助，更不容易写出脏宏和过程宏。</p> <p>总结一下就是 syntax-rules 削弱了传统照应宏的表达能力，这也是它最受诟病的一点。但是削弱的程度非常低，只有非常少数的过程需要 syntax-case 去实现（例如带continue和break的循环以及产生外部定义的宏），因此目前define-syntax嵌套syntax-rules已经成为主流用法。目前鸭库中的所有宏的写法都用了这样的用法。</p> <p>说了这么多什么是过程宏，什么是卫生宏该给出定义了。简单的说卫生宏引入的名字都会被重命名。过程宏对引入的名字则不做处理。简单的说就是卫生宏不会出现内部的标识符与外部标识符打架的情况。</p> <h2 id="保留字"><a href="#保留字" class="header-anchor">#</a> 保留字</h2> <div class="language-scheme extra-class"><pre class="language-scheme"><code><span class="token punctuation">(</span><span class="token keyword">define-syntax</span> for
    <span class="token punctuation">(</span><span class="token keyword">syntax-rules</span> <span class="token punctuation">(</span><span class="token function">to</span><span class="token punctuation">)</span>
      [<span class="token punctuation">(</span><span class="token function">_</span> i <span class="token punctuation">(</span><span class="token function">from</span> to end<span class="token punctuation">)</span> body ...<span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token function">[i</span> from]<span class="token punctuation">)</span>
         <span class="token punctuation">(</span><span class="token keyword">when</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span> i end<span class="token punctuation">)</span> body ... <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token operator">+</span> i <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>] <span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>我们引入一个新例子，就是上面这个。其中<code>syntax-rules (to)</code>中的括号内不再是空的，而是有一个<code>to</code>。其中to就是保留字，代表着在宏中起到语法分割且不被处理的字。不是所用宏定义都需要保留字，哪怕是分段的语法结构也不一定要有保留字，例如scheme的if就没有使用任何保留字。但是当读者用宏定义C语言风格式的if语句时就必须添加else保留字，对于某些语言来说，还必须增加elseif和end保留字，因此保留字可不止一个</p> <h2 id="模式-映射"><a href="#模式-映射" class="header-anchor">#</a> 模式 映射</h2> <p>为说明模式和映射的概念，此处使用伪代码重写上面的例子</p> <div class="language-scheme extra-class"><pre class="language-scheme"><code><span class="token punctuation">(</span><span class="token function">定义宏</span>
    <span class="token punctuation">(</span><span class="token function">清洁宏</span>
      [模式
       映射] <span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>请仔细对比伪代码与代码的区别，上面for的宏中模式部分是<code>(_ i (from to end) body ...)</code>说明的是for宏输入的语法格式，为了调用这个宏需要有至少四个参数，这里以<code>i from end body</code>等表示。<code>...</code>表示的是不定长度的参数，值得注意的是此处的<code>...</code>表示的不定长度的参数的参数性质是与<code>body</code>性质相同的参数。
宏中映射部分是<code>(when (&lt; i end) body ... (loop (+ i 1))))</code>，宏的映射部分是最考量编程者水平的部分，也有很多神奇的写法。但是这里写的语法就是函数中也很常见的内容。有两点不同，就是里面的body可以是一个S表达式，而函数的一般不行。另一点请看下面的部分。</p> <h2 id="照应"><a href="#照应" class="header-anchor">#</a> 照应</h2> <p>照应性在编程中无处不在，一般而言传值、声明、定义中都有照应，上面for宏的例子中，i from 和 end 和函数的参数照应方式一致，body 也只不过是可以照应 S 表达式而已，比如body中的内容可以传入(display &quot;marcos&quot;)，或者更多的S表达式。</p> <p>这里说的是 <code>...</code>的照应，为了说明这一问题，继续从鸭库引用一个例子</p> <div class="language-scheme extra-class"><pre class="language-scheme"><code><span class="token punctuation">(</span><span class="token keyword">define-syntax</span> defun
  <span class="token punctuation">(</span><span class="token keyword">syntax-rules</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> proc args ...<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token keyword">define</span> proc
       <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token lambda-parameter">args</span> ...<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>这是一个实现Lisp风格定义函数的宏，语义基本和define一样，通过这个例子对于<code>...</code>的照应关系读者应该就比较明确了，凡是模式中出现的<code>...</code>，映射中也必须出现。<code>...</code>在映射中往往也和他的前一个参数一起出现，因为在宏中这<code>...</code>代表了零个或不限数量个与前面参数相同性质的参数。值得一提的是，模式和映射中都可以出现多个<code>...</code>，只要它们数量相同，而且符合scheme关于宏的要求。</p> <h2 id="多模式-多映射"><a href="#多模式-多映射" class="header-anchor">#</a> 多模式 多映射</h2> <p>一般来说<code>if ... else</code>的语法结构是两段式的，而<code>if ... elseif ... else</code>的语法结构可能出现三段式乃至多段式。多段式的语法结构为了丰富表达能力可能在不同的用途时采用不同的保留字。
比如上面提到的<code>if ... elseif ... else</code>即可以构造成<code>if ... else</code>也可以构造成<code>if ... elseif ... elseif ... elseif ... else</code>的样子。鸭库中的代码也有类似的，请看下面这个例子。</p> <div class="language-scheme extra-class"><pre class="language-scheme"><code><span class="token punctuation">(</span><span class="token keyword">define-syntax</span> for
  <span class="token punctuation">(</span><span class="token keyword">syntax-rules</span> <span class="token punctuation">(</span><span class="token function">to</span><span class="token punctuation">)</span>
    <span class="token comment">;; loop in sequence</span>
    <span class="token comment">;; (for i (0 to 10) do something...)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> i  <span class="token punctuation">(</span><span class="token function">from</span> to end<span class="token punctuation">)</span> body ...<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token keyword">when</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span> i end<span class="token punctuation">)</span>
             body ...
             <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token operator">+</span> i <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">;; loop in list</span>
    <span class="token comment">;; (for i in '(a b c) do something...)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> i in lst body ...<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">l</span> lst<span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token keyword">unless</span> <span class="token punctuation">(</span><span class="token builtin">null?</span> l<span class="token punctuation">)</span>
               <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token punctuation">(</span><span class="token builtin">car</span> l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                 body ...
                 <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>下面的这个for构造的宏既实现了basic风格的for循环，又实现了Python风格的for循环，可将scheme的列表作为枚举器进行枚举。因此该宏有两个模式，两种映射</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">12/11/2020, 1:11:36 PM</span></div></footer> <!----> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/scheme-lib/assets/js/app.7d3796fb.js" defer></script><script src="/scheme-lib/assets/js/2.717986cd.js" defer></script><script src="/scheme-lib/assets/js/3.3680f9a6.js" defer></script><script src="/scheme-lib/assets/js/16.d05c1140.js" defer></script>
  </body>
</html>
